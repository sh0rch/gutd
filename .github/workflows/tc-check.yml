name: TC/XDP eBPF Module Verification

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/tc/**'
      - 'src/config.rs'
      - 'src/tun.rs'
      - 'build.rs'
      - '.github/workflows/tc-check.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/tc/**'
      - 'src/config.rs'
      - 'src/tun.rs'
      - 'build.rs'

env:
  CARGO_TERM_COLOR: always

jobs:
  tc-compilation:
    name: TC/XDP eBPF Compilation & Safety Check
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Install eBPF dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libbpf-dev \
          libelf-dev \
          linux-headers-$(uname -r) \
          clang \
          llvm

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-tc-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --check

    - name: Clippy (strict)
      run: |
        cargo clippy --all-targets -- \
          -D warnings \
          -D clippy::all \
          -A clippy::module-name-repetitions \
          -A clippy::missing-errors-doc \
          -A clippy::missing-panics-doc

    - name: Build with default features (tc_ebpf)
      run: cargo build --verbose

    - name: Run all tests
      run: cargo test --verbose

    - name: Verify unsafe code boundaries
      run: |
        echo "=== Checking unsafe blocks in TC eBPF loader ==="
        grep -n "unsafe" src/tc/loader.rs || echo "No unsafe blocks found"
        echo ""
        echo "=== Checking unsafe blocks in maps ==="
        grep -n "unsafe" src/tc/maps.rs || echo "No unsafe blocks found"
        echo ""
        echo "=== Checking unsafe blocks in tun ==="
        grep -n "unsafe" src/tun.rs || echo "No unsafe blocks found"

    - name: Verify eBPF skeleton generation
      run: |
        echo "=== Checking generated eBPF skeletons ==="
        ls -la target/debug/build/gutd-*/out/*.skel.rs 2>/dev/null || echo "Skeletons in build dir"
        echo "=== Verifying BPF object files compile ==="
        ls -la src/tc/bpf/*.o 2>/dev/null && echo "✓ BPF objects present" || echo "BPF objects built during cargo build"

    - name: Verify Drop implementation
      run: |
        if ! grep -q "impl Drop for TcBpfManager" src/tc/loader.rs; then
          echo "FAIL: Missing Drop implementation for TcBpfManager"
          exit 1
        fi
        echo "✓ TcBpfManager Drop implementation found"

    - name: Security audit
      run: |
        cargo install cargo-audit || true
        cargo audit || echo "Advisory database check completed"

  tc-musl-build:
    name: TC/XDP musl Static Build
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-musl

    - name: Install musl-tools and eBPF dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          musl-tools \
          libbpf-dev \
          libelf-dev \
          linux-headers-$(uname -r) \
          clang \
          llvm

    - name: Build musl static binary
      run: |
        mkdir -p /tmp/kheaders
        ln -s /usr/include/linux /tmp/kheaders/linux
        ln -s /usr/include/x86_64-linux-gnu/asm /tmp/kheaders/asm
        ln -s /usr/include/asm-generic /tmp/kheaders/asm-generic
        ln -s /usr/include/libelf.h /tmp/kheaders/libelf.h
        ln -s /usr/include/gelf.h /tmp/kheaders/gelf.h
        ln -s /usr/include/elfutils /tmp/kheaders/elfutils
        export CFLAGS_x86_64_unknown_linux_musl="-I/tmp/kheaders"
        cargo build --release --target x86_64-unknown-linux-musl

    - name: Verify static linking
      run: |
        file target/x86_64-unknown-linux-musl/release/gutd
        ldd target/x86_64-unknown-linux-musl/release/gutd || echo "✓ Static binary (expected)"

    - name: Verify binary starts
      run: |
        target/x86_64-unknown-linux-musl/release/gutd --version
        echo "✓ Binary executable"
